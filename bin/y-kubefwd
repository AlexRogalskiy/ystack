#!/bin/sh
[ -z "$DEBUG" ] || set -x
set -e
YBIN="$(dirname $0)"

version=1.14.0

ctx=$1
case $ctx in
  "--context="*) shift 1 ;;
  *) echo "Warning: deprecated use of default context for kubefwd" ;;
esac

if [ $(id -u) -ne 0 ] && \
    [ ! -z "$ctx" ] && \
    [ "0" == "$(kubectl $ctx -n ystack get statefulset buildkitd -o jsonpath='{.spec.replicas}')" ]; then
  echo "buildkitd is at scale zero, scaling up before port forward ..."
  kubectl $ctx -n ystack scale --replicas=1 statefulset buildkitd
  kubectl-waitretry $ctx -n ystack --timeout=10s --for=condition=ready pod buildkitd-0
fi

bin_name=kubefwd \
  bin_version=v${version} \
  Darwin_url=https://github.com/txn2/kubefwd/releases/download/${version}/kubefwd_Darwin_amd64.tar.gz \
  Darwin_sha256=1cb03198526192f21d632d531575ed91f6e7a58b5897bdb5814ed524c5e3d607 \
  Linux_url=https://github.com/txn2/kubefwd/releases/download/${version}/kubefwd_linux_amd64.tar.gz \
  Linux_sha256=f202a030aeaa6f9c5e0e6b764a0426a309662e81bab33505296c07391fc62b40 \
  bin_tgz_path=kubefwd \
  $YBIN/y-bin-dependency-download || exit $?

[ $(id -u) -ne 0 ] && echo "su privileges required for kubefwd" && exec sudo -E $0 $@

$YBIN/y-kubefwd-v${version}-bin "$@" || exit $?
