#!/bin/sh
[ -z "$DEBUG" ] || set -x
set -e

OPERATOR_VERSION=c0fcbc4b7614d0f90a97cc9eee63facfbca6d700
KUBERNETES_ASSERT_VERSION=086d92102ed8e3ca4595c4ca0fb200072da3a84a

ctx=$1
case $ctx in
  "--context="*) shift 1 ;;
  *) echo "Initial arg must be --context=" && exit 1 ;;
esac

# If we're to make this script idempotent we must make sure that re-applying the operator's bundle isn't painfully slow
kubectl $ctx create namespace monitoring

kubectl $ctx -n default apply -f https://github.com/coreos/prometheus-operator/raw/$OPERATOR_VERSION/bundle.yaml

kubectl-waitretry $ctx -n default --for=condition=Ready pod -l app.kubernetes.io/name=prometheus-operator

kubectl $ctx -n monitoring apply -k github.com/Yolean/kubernetes-assert/example-small?ref=$KUBERNETES_ASSERT_VERSION

kubectl-waitretry $ctx -n monitoring --for=condition=Ready pod --all
