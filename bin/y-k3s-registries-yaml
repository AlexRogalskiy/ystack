#!/usr/bin/env bash
[ -z "$DEBUG" ] || set -x
set -eo pipefail

[ -n "$YSTACK_PROD_REGISTRY" ] || {
  YSTACK_PROD_REGISTRY=http://prod-registry.ystack.svc.cluster.local
}

[ "$1" = "help" ] && echo '
Examples:
# default ystack k3s config, typically requiring node tweaks using daemonsets found at registry/node-update-*
y-k3s-registires-yaml
# Artifact Registry where you rewrite image URLs before applying
YSTACK_PROD_REGISTRY=https://europe-west3-docker.pkg.dev y-k3s-registires-yaml
# Artifact Registry experimental transparent rewrite, note how URLs depends on GCP region, project and registry names
YSTACK_PROD_REGISTRY=https://europe-west3-docker.pkg.dev YSTACK_PROD_REGISTRY_REWRITE='"^myorg/(.*)": "my-gcp-proj/my-artifact-registry/myorg/$1"' y-k3s-registires-yaml
' && exit 0

cat <<EOF
mirrors:
  "builds-registry.ystack.svc.cluster.local":
    endpoint:
    - http://builds-registry.ystack.svc.cluster.local
  "prod-registry.ystack.svc.cluster.local":
    endpoint:
    - $YSTACK_PROD_REGISTRY
EOF

[ -z "$YSTACK_PROD_REGISTRY_REWRITE" ] || {
  # https://github.com/rancher/rke2/issues/741#issuecomment-824252661
  cat <<EOF
    rewrite:
      $YSTACK_PROD_REGISTRY_REWRITE
EOF
}

case $YSTACK_PROD_REGISTRY in
  prod-registry.ystack.svc.cluster.local)
    cat <<EOF
  "prod-registry.ystack.svc.cluster.local":
    endpoint:
    - $YSTACK_PROD_REGISTRY
EOF
    [ -z "$YSTACK_PROD_REGISTRY_REWRITE" ] || {
    cat <<EOF
    rewrite:
      $YSTACK_PROD_REGISTRY_REWRITE
EOF
    }
    ;;
  *-docker.pkg.dev)
    [ -n "$YSTACK_PROD_REGISTRY_REWRITE" ] || {
    cat <<EOF
    # Note: Artifact Registry pull as mirror will probably fail without a rewrite directive
EOF
    }
    cat <<EOF
configs:
  "*-docker.pkg.dev":
    auth:
      username: oauth2accesstoken
      password: "$(gcloud auth print-access-token)"
EOF
    ;;
esac
