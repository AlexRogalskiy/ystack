#!/usr/bin/env bash
[ -z "$DEBUG" ] || set -x
set -eo pipefail

[ -z "$KUBECONFIG" ] && echo "Provision requires an explicit KUBECONFIG env" && exit 1

[ -z "$CONTEXTNAME" ] && CONTEXTNAME=local

COMPOSEFILES="-f $YSTACK_HOME/docker-compose.test.yml -f $YSTACK_HOME/docker-compose.dev-overrides.yml -f $YSTACK_HOME/docker-compose.builds.yml $COMPOSEFILES"
echo "# docker-compose $COMPOSEFILES"

status=$(docker-compose $COMPOSEFILES ps -q)
if [ ! -z "$status" ]; then
  echo "# Aborting because there seems to exist ystack containers already. See:"
  echo docker-compose $COMPOSEFILES ps
  echo "# To tear down:"
  echo docker-compose $COMPOSEFILES up cleanup
  echo docker-compose $COMPOSEFILES down --remove-orphans -v
  exit 1
fi

# --no-build is a workaround for https://github.com/docker/compose/issues/3729
docker-compose $COMPOSEFILES up --no-build -d ystack-proxy

docker-compose $COMPOSEFILES exec master1 sh -c 'until test -f /admin/.kube/kubeconfig.yaml; do sleep 1; done; cat /admin/.kube/kubeconfig.yaml' \
  > "$KUBECONFIG.tmp"

KUBECONFIG="$KUBECONFIG.tmp" kubectl config rename-context default $CONTEXTNAME

y-kubeconfig-import "$KUBECONFIG.tmp"

YSTACK_SUT_KEEP_RUNNING=false docker-compose $COMPOSEFILES up --no-build sut

# specs currently don't clean up after themselves
kubectl --context=$CONTEXTNAME -n ystack-specs scale --replicas=0 deploy --all

echo "Done"
echo "Note the remarks about /etc/hosts in README.md"
